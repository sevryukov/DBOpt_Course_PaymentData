### **Задача 1.**

_Дать оценку затрат на выполнения операций расчёта балансов в рамках транзакций создания и изменения платежа. Желательно представить количественную оценку, но допустимо и относительную (к примеру, "90% ресурсов и времени уходит на расчёт баланса"). Чем детальнее, тем лучше._

Для оценки времени исполнения использовался встроенный в Microsoft SQL Server Management Studio инструмент Live Query Statistics. В скобках отражено относительное время исполнения. 

**Вставка новой записи включала:**

    1. Вставка новой записи в таблицу Payment (1%)
    2. Обновление баланса у новых участников (22%):
      2.1. Вычисление функции F_CalculatePaymentParticipantBalance для плательщика (5%)
      2.2. Обновление баланса в таблице PaymentParticipant для плательщика (6%)
      2.3. Вычисление функции F_CalculatePaymentParticipantBalance для получателя (5%)
      2.4. Обновление баланса в таблице PaymentParticipant для получателя (6%)
    3. Обновление баланса у старых участников (22%):
      3.1. Вычисление функции F_CalculatePaymentParticipantBalance для плательщика (5%)
      3.2. Обновление баланса в таблице PaymentParticipant для плательщика (6%)
      3.3. Вычисление функции F_CalculatePaymentParticipantBalance для получателя (5%)
      3.4. Обновление баланса в таблице PaymentParticipant для получателя (6%)
    4. Обновление баланса у новых объектов (27%):
      4.1. Вычисление функций F_CalculateBalanceByMaterial, F_CalculateBalanceByWork и  F_CalculateProjectBalance (8%)
      4.2. Обновление баланса в таблице Project (19%)
    5. Обновление баланса у старых объектов (27%):
      5.1. Вычисление функций F_CalculateBalanceByMaterial, F_CalculateBalanceByWork и  F_CalculateProjectBalance (8%)
      5.2. Обновление баланса в таблице Project (19%)
    
Схожие показатели получаются при **обновлении существующей записи** в таблице Payment, только сама операция обновления занимает 0% процессорного времени, а пункты 4.1 и 5.1 по 9%.
Видно, что обновление таблиц более длительная операция по сравнению с операцией расчетом баланса. Поэтому возможные сценарии оптимизации должны быть направлены в первую очередь на уменьшении времени, затрачиваемого на обновление балансов.


### **Задача 2.**

_Введём две роли пользователей: бухгалтер-оператор и бухгалтер-аналитик._

_Оператор - занимается вводом и корректировкой платежей, не имеет доступа к данным о балансах._

_Бухгалтер-аналитик - отслеживает балансы и заведённые платежи для принятия решения о предпринимаемых финансовых действиях (какие счета использовать, какие образовались долги и т.д.)._

_Предложить сценарий оптимизации механизмов расчёта. Сценарий должен допускать максимизацию скорости целевых изменений и допускать отложенное вычисление балансов (балансы и данные платежей должны быть согласованы в конечном счёте)._

При использовании данных двух ролей появляется возможность оптимизировать работу базы данных, используя механизм отложенного платежа. Роль оператора ограничивается только записью новых данных без доступа в данным о балансах, поэтому нет необходимости производить перерасчет балансов после каждого внесения оператором новой записи в таблицу Payment. Перерасчет балансов требуется только перед началом работы бухгалтера. В связи с этим были предложены 2 возможных сценария оптимизации работы базы данных:

**1.	Добавление в таблицу Payment нового столбца-флага**

Данный столбец используется для обозначения новый внесенных записей, обработка которых отложена, а также обновленных записей. После обработки записи значение флага меняется на противоположное.

**2.	Использования вспомогательной таблицы PaymentDelayed.**

При добавлении нового платежа запись вносится не в таблицу Payment, а во вспомогательную таблицу PaymentDelayed, из которой затем накопленные записи одной транзакцией вносятся в основную таблицу и вызывают обновление балансов. После переноса накопленных транзакций записи во вспомогательной таблице должны быть удалены.
Перерасчет балансов может производиться с какой-то периодичностью или при накоплении какого-то наперед заданного количества необработанных записей. 

### **Задача 3.**

_Оценить недостатки предлагаемого сценария с точки зрения потенциальных пользователей._

**С точки зрения реализации:**

  1. Первый подход требует изменения существующего кода (триггера, вызываемого после внесения записи в таблицу Payment).
  2. Оба подхода подразумевают определения управления для вызова функций перерасчета балансов.
  
**С точки зрения пользователей:**

  1. Оба подхода не накладывают никаких ограничений на работу оператора. С другой стороны, одновременная работа оператора и бухгалтера либо вообще не должна происходить, либо бухгалтер будет работать с неактуальными данными. В последнем случае требуется поиск оптимального соотношения между актуальностью информации и производительностью за счет выбора частоты обновления или максимального количества новых записей, которые могут быть необработанными. 
Несущественный недостаток, если ограничиваться только 2 ролями. Если же, например, вводится третья роль пользователя, который хочет посмотреть свой долг или баланс, то потребуется намного больше обновлений и уже встанет вопрос целесообразности накопления необработанных платежей.
  2. Необходимость запуска, возможно ручного, перерасчета балансов, который может потребовать времени, если было внесено много записей, тем самым бухгалтер не сможет сразу получить актуальную информацию. 
